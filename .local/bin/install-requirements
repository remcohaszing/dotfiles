#!/usr/bin/env bash

shopt -s nullglob

function die() {
  echo "$1"
  exit 1
}

if [ "$1" == '-h' ]; then
  die 'Install requirements files in this directory and any subdirectory in this virtualenv.'
fi

BOLD='\e[1m'
CYAN='\e[96m'
RED='\e[31m'
YELLOW='\e[33m'
RESET='\e[0m'

setup=()
dev_dependencies=(pdbpp pytest-watch)
requirements_files=(*requirements.txt */*requirements.txt)

if [ ${#requirements_files[@]} == 0 ]; then
  die 'Could not find any requirements files.'
else
  echo 'Force reinstalling setuptools and its dependenciesâ€¦'
  pip install --force-reinstall setuptools
  if [ -f setup.py ]; then
    echo 'Installing in editable mode:'
    echo -e "  $BOLD$RED${PWD}/setup.py$RESET"
    setup+=(-e "$PWD")
  fi
  echo 'Installing the following dependencies:'
  printf "  $BOLD$YELLOW%s$RESET\n" "${dev_dependencies[@]}"
  echo 'Installing the following requirements files:'
  printf "  $BOLD$CYAN%s$RESET\n" "${requirements_files[@]}"
  pip install "${setup[@]}" "${dev_dependencies[@]}" "${requirements_files[@]/#/-r}"
fi
